---
output: html_document
title: "UKB results for pPGSxE proof-of-concept study"
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F,warning = F, 
                      dpi = 150, fig.path = "../output/ukb_results/",
                      cache.path = "../cache/ukb_results/")
suppressMessages(silent <- lapply(
  c("knitr", "kableExtra", "tidyverse", "patchwork"), 
  library, character.only = TRUE))
theme_set(theme_bw())
```

```{r load-data}
ukb_subset_names <- c("training", "testing")
ukb_subset_names_clean <- c("Training", "Testing")
ukb_subsets <- map(set_names(ukb_subset_names), function(set) {
  read_csv(paste0("../data/processed/ukb_", set, "_set.csv"), show_col_types = FALSE) %>%
    mutate(across(matches("^gPC"), ~ . * bmi, .names = "bmiBy{.col}"))
})

ancestry_df <- read_csv("../data/processed/ukb_phenos_panUKBB.csv", 
                        col_select = c(id, ancestry), show_col_types = FALSE)
ancestries <- unique(ancestry_df$ancestry[!is.na(ancestry_df$ancestry)])
```

# Concept summary: pPGS for GxE

```{r workflow-diagram, eval=F}
knitr::include_graphics("../doc/workflow_diagram.pdf")
```

```{r configuration}
exposures <- c("bmi")
exposures_clean <- c("BMI")

outcomes <- c("alt_log", "ast_log", "ggt_log")
outcomes_clean <- c("log(ALT)", "log(AST)", "log(GGT)")

thresholds <- c("5e-08", "0.001")
threshold_names <- paste0("Pt_", c("5e-08", "0.001"))
threshold_names_clean <- c("P<5e-8", "P<0.001")

ppgs_config_df <- expand_grid(
  e = exposures,
  y = outcomes,
  threshold = thresholds,
  set = names(ukb_subsets)
)
```

Overall dataset consists of unrelated, multi-ancestry individuals from the UKBB (based on Pan-UKBB; N ~ 320,000).

* 70% training set: GWAS
* 30% testing set: evaluation

Primary metric for evaluation: significance of regression pPGSxE term

Variables being manipulated:

* Outcome: 3 liver-related biomarkers (ALT, AST, GGT)
* P&T threshold: 0.001, 5e-8

# Data distributions

Plots reflect the testing set.

```{r histograms, out.width="40%"}
plot_histogram <- function(f) {
  ukb_subsets$testing %>%
    select(x = {{ f }}) %>%
    filter(!is.na(x)) %>%
    ggplot(aes(x = x)) +
    geom_histogram(stat = "bin", bins = 30) +
    labs(x = f)
}

alt_hist <- plot_histogram("alt_log")
ast_hist <- plot_histogram("ast_log")
ggt_hist <- plot_histogram("ggt_log")

alt_hist + ast_hist + ggt_hist

# for (outcome in outcomes) {
#   print(plot_histogram(outcome))
# }
```

# PGS performance

```{r pgs-testing-prep}
gPCs <- paste0("gPC", 1:10)
primary_covars <- c("sex", "age", "age_squared", "ageBySex", gPCs)
liver_bms <- c("alt_log", "ast_log", "ggt_log")
```

```{r ppgs-results, fig.asp=1.2}
read_pgs_prset <- function(tag, thresh) {
  ppgs_df <- read_delim(paste0("../data/processed/pgs/", tag, "_prset.all_score"),
                       delim = " ", show_col_types = FALSE) %>%
    select(id = IID, everything(), -FID)
    # rename_with(~ str_replace_all(., "_[\\d\\.]+$", ""), -id)
  ppgs_df
}

test_single_ppgs_gxe <- function(e, y, regression_df, covars, standardize) {
  if (standardize) {
    regression_df <- mutate(regression_df,
                            across(all_of(c(e, y, "ppgs")), ~ as.vector(scale(.x))))
  }
  lm_form_str <- paste0(y, " ~ ppgs * ", e)
  if (!is.null(covars)) {
    lm_form_str <- paste0(lm_form_str, " + ", paste(covars, collapse = " + "))
  }
  lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
  lm_fit %>%
    broom::tidy() %>%
    filter(term == paste0("ppgs:", e))
}

# get_ppgs_weights <- function(e, y, tag, thresh, set, covars) {
#   pgs_df <- read_pgs_prset(tag, thresh)
#   if (!(thresh == "all")) {
#     pgs_df <- select(pgs_df, id, contains(thresh))
#   }
#   pathways <- setdiff(names(pgs_df), "id")
#   regression_df <- inner_join(ukb_subsets[[set]], pgs_df, by = "id")
#   lm_form_str <- paste0(y, " ~ pgs * ", e)
#   if (!is.null(covars)) {
#     lm_form_str <- paste0(lm_form_str, " + ", paste(covars, collapse = " + "))
#   }
#   univariate_ppgs_gxe_df <- parallel::mclapply(
#     setNames(pathways, pathways), 
#     function(p) {
#       regression_df$pgs <- regression_df[[p]]
#       lm_fit <- lm(as.formula(lm_form_str), data = regression_df)
#       lm_fit %>%
#         broom::tidy() %>%
#         filter(term == paste0("pgs:", e))
#     }, 
#     mc.cores = 16) %>%
#     bind_rows(.id = "pathway")
#   univariate_ppgs_gxe_df
# }


# ppgs_calc_df <- readRDS("../data/processed/pgs/ppgs_vec_df.rds")


test_all_ppgs_gxe <- function(e, y, threshold, set, covars, 
                          ancestry_test = "all", standardize = TRUE) {
  ppgs_df <- read_pgs_prset(y) %>%
    select(id, contains(threshold))
  pathways <- gsub(paste0("_", threshold), "", setdiff(names(ppgs_df), "id"))
  regression_df <- inner_join(ukb_subsets[[set]], ppgs_df, by = "id")
  if (ancestry_test != "all") {
    regression_df <- inner_join(regression_df, ancestry_df, by = "id") %>%
      filter(ancestry == ancestry_test)
  }
  map(pathways[1:3], function(p) {
    print(paste0(p, "_", threshold))
    regression_df$ppgs <- regression_df[[paste0(p, "_", threshold)]]
    test_single_ppgs_gxe(e, y, regression_df, covars, standardize)
  }) %>%
    setNames(pathways[1:3]) %>%
    bind_rows(.id = "pathway")
}
# test_all_ppgs_gxe("bmi", "alt_log", "0.001", "testing",
#                   c(primary_covars, paste0("bmiBy", gPCs)))

ppgs_res_df <- pgs_config_df %>%
  select(e, y, tag, threshold) %>%
  distinct() %>%
  rowwise() %>%
  mutate(pathway_fits = list(
    get_ppgs_weights(e, y, paste0(y, "_prset"), threshold, "validation",
                     c(primary_covars, paste0(e, "By", gPCs)))
  ))
```

```{r, show-weights, fig.asp=1}
ppgs_calc_df %>%
  filter(y %in% liver_bms) %>%
  unnest(pathway_fits) %>%
  mutate(l95 = estimate - 1.96 * std.error,
         u95 = estimate + 1.96 * std.error) %>%
  arrange(estimate) %>%
  mutate(pathway = factor(pathway, levels = pathway, 
                          labels = str_replace(pathway, "HALLMARK_", ""))) %>%
  ggplot(aes(x = pathway, y = estimate)) +
  geom_hline(yintercept = 0, color = "gray") +
  geom_point() +
  geom_errorbar(aes(ymin = l95, ymax = u95)) +
  facet_wrap(vars(y), ncol = 1, scale = "free_y") +
  labs(x = "", y = "pPGSxE effect size (95% CI)",
       title = "Pathway-specific PGS interaction results") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9, size = 4))

ppgs_calc_df %>%
  filter(y %in% liver_bms,
         threshold != "all") %>%
  unnest(pathway_fits) %>%
  arrange(p.value) %>%
  mutate(p.value = signif(p.value, 3)) %>%
  select(biomarker = y, pathway, pgs_p_threshold = threshold, estimate, std.error, p.value) %>%
  write_csv("../output/ppgs_interaction_estimates.csv")
  # select(Biomarker = y, `pPGS p-value threshold` = threshold,
  #        `pPGSxBMI estimate` = estimate, SE = std.error, P = p.value)
```

# Specific visualizations

```{r example-viz, eval=F}
e <- "bmi"
y <- "hscrp_log"
tag <- "bmi_hscrp_log"
thresh_name <- "Pt_5e-08"
e_clean <- "BMI"
y_clean <- "log(hsCRP)"
# ppgs_df <- filter(ppgs_df, e == e)
regression_df <- inner_join(ukb_subsets$testing, ppgs_df, by = "id") %>%
  filter(!is.na(.data[[e]]), !is.na(.data[[y]])) %>%
  mutate(pgs_bin = cut(pgs, quantile(pgs, seq(0, 1, length.out = 11)), 
                       include.lowest = TRUE, labels = paste0("Q", 1:10)))
```

```{r, eval = FALSE}
regression_df %>%
  ggplot(aes(x = bmi, y = hscrp_log)) +
  geom_smooth(method = "gam", formula = y ~ rms::rcs(x, 5)) +
  labs(x = e_clean,
       y = y_clean)
```

```{r, eval = FALSE}
for (tag in c("hscrp_log", "bmi_hscrp_log", "hscrp_log_vQTL", "hscrp_log_prset")) {
  df <- read_table(paste0("../data/processed/pgs/", tag, ".all_score"), 
                 show_col_types = FALSE)
  print(head(df))
}
```

```{r, eval = FALSE}
pgs_test_main_res_df %>%
  left_join(optimal_pgs_main_df, by = c("y", "pgs_type", "thresh_name")) %>%
  filter(y == "hscrp_log") %>%
  mutate(color = if_else(set == "validation", optimal, NA),
         statistic = if_else(set == "testing" & optimal == FALSE, NA, statistic),
         y = factor(y, levels = outcomes, labels = paste0(outcomes_clean, " set")),
         set = factor(set, levels = ukb_subset_names, 
                      labels = ukb_subset_names_clean),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = thresh_name, y = statistic, color = color)) +
  geom_bar(stat = "identity") +
  scale_color_discrete(name = "Optimal", na.translate = FALSE) +
  facet_wrap(vars(set), nrow = 1, scale = "free_y") +
  labs(x = "", y = "PGS main effect z-statistic",
       title = "Positive control: standard GWAS/main effects pipeline") +
  theme(axis.text.x = element_text(angle = 25, hjust = 0.9))
```

```{r, fig.width=5, eval = FALSE}
all_pgs_test_res_df %>%
  filter(set == "testing",
         e == "bmi",
         y == "hscrp_log") %>%
  mutate(e = factor(e, levels = exposures, labels = exposures_clean),
         y = factor(y, levels = outcomes, labels = outcomes_clean),
         pgs_type = factor(pgs_type, levels = pgs_types, labels = pgs_types_clean),
         set = factor(set, levels = names(ukb_subsets), 
                      labels = paste0(str_to_title(names(ukb_subsets)), " set")),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = pgs_type, y = statistic, fill = pgs_type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0, color = "gray") +
  scale_fill_discrete(name = "PGS type") +
  labs(x = "", y = "Interaction test z-statistic",
       title = "PGSxE testing (testing set)") +
  theme(axis.text.x = element_text(angle = 20, hjust = 0.9))
```

```{r, eval = FALSE}
quantile_lines_plt <- regression_df %>%
  ggplot(aes(x = bmi, y = hscrp_log, group = pgs_bin, color = pgs_bin)) +
  # ggplot(aes(x = {{e}}, y = {{y}}, group = pgs_bin, color = pgs_bin)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  scale_color_discrete(name = "PGS bin") +
  coord_cartesian(xlim = quantile(regression_df[[e]], c(0.001, 0.999))) +
  labs(x = e_clean,
       y = y_clean)

test_ey <- function(df, e, y, covars) {
  lm_form_str <- paste0(y, " ~ ", e, " + ", paste(covars, collapse = " + "))
  lm_fit <- lm(as.formula(lm_form_str), data = df)
  lm_fit %>%
    broom::tidy() %>%
    filter(term == e)
}

quantile_effects_df <- regression_df %>%
  nest(data = -pgs_bin) %>%
  rowwise() %>%
  mutate(ey_lm = test_ey(data, e, y, primary_covars)) %>%
  select(-data) %>%
  unnest(ey_lm)
quantile_effects_plt <- quantile_effects_df %>%
  select(pgs_bin, estimate) %>%
  ggplot(aes(x = pgs_bin, y = estimate)) +
  geom_point() +
  labs(x = "PGS bin",
       y = paste0(e_clean, " - ", y_clean, " effect size"))

quantile_lines_plt + quantile_effects_plt

quantile_effects_df %>%
  arrange(pgs_bin) %>%
  select(pgs_bin, estimate) %>%
  mutate(factor_change = estimate / estimate[1])

# q1_corr <- cor.test(~ hscrp_log + whr, data = filter(regression_df, pgs_bin == "Q1"))$estimate
# q10_corr <- cor.test(~ hscrp_log + whr, data = filter(regression_df, pgs_bin == "Q10"))$estimate
# 
# print(paste0("WHR-log(hsCRP) correlation in lowest vs. highest decile: ",
#              round(q1_corr, 2), " versus ", round(q10_corr, 2)))
```

```{r, fig.asp=1.4, eval = FALSE}
all_pgs_test_res_df %>%
  filter(set == "testing",
         e == "bmi") %>%
  mutate(e = factor(e, levels = exposures, labels = exposures_clean),
         y = factor(y, levels = outcomes, labels = outcomes_clean),
         pgs_type = factor(pgs_type, levels = pgs_types, labels = pgs_types_clean),
         set = factor(set, levels = names(ukb_subsets), 
                      labels = paste0(str_to_title(names(ukb_subsets)), " set")),
         thresh_name = factor(thresh_name, 
                              levels = threshold_names,
                              labels = threshold_names_clean)) %>%
  ggplot(aes(x = pgs_type, y = statistic, fill = pgs_type)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = 0, color = "gray") +
  scale_fill_discrete(name = "PGS type") +
  facet_wrap(vars(y), ncol = 1, scale = "free_y") +
  labs(x = "", y = "Interaction test z-statistic",
       title = "iPGSxBMI results (testing set)") +
  theme(axis.text.x = element_text(angle = 20, hjust = 0.9))
```

```{r, eval = FALSE}
ppgs_weights_df %>%
  filter(e == "bmi",
         y == "hscrp_log") %>%
  unnest(pathway_fits) %>%
  arrange(estimate) %>%
  mutate(pathway = factor(pathway, levels = pathway, 
                          labels = str_replace(pathway, "HALLMARK_", ""))) %>%
  ggplot(aes(x = pathway, y = estimate)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "pPGSxBMI univariate effect size",
       title = "Example pPGS optimization (validation set)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9))
```


